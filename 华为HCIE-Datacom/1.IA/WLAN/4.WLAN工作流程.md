```
WLAN工作流程：步骤1
```
 
```
AP上线：  
FIT AP需完成上线过程，AC才能实现对AP的集中管理和控制，以及业务下发。  
AP的上线过程包括如下步骤：  
AP获取IP地址；  
AP发现AC并与之建立CAPWAP隧道；  
AP接入控制；  
AP版本升级；  
CAPWAP隧道维持。
```
 
```
1.AP获取IP地址的方式包括以下：  
静态方式：  
登录到AP设备上手工配置IP地址。  
DHCP方式：  
通过配置DHCP服务器，使AP作为DHCP客户端向DHCP服务器请求IP地址。  
典型方案：  
1.部署专门的DHCP Server为AP分配IP地址。  
2.使用AC的DHCP服务为AP分配IP地址。  
3.使用网络中的设备，例如核心交换机为AP分配IP地址。
```

![Exported image](Exported%20image%2020251206145900-0.png)   
```
2.CAPWAP隧道建立  
Step 1：Discovery阶段（AP发现AC阶段）：  
AP通过发送Discovery Request报文，找到可用的AC。  
AP发现AC有两种方式：  
静态方式：AP上预先配置AC的静态IP地址列表。  
动态方式：DHCP方式、DNS方式和广播方式。  
Step 2：建立CAPWAP隧道阶段：  
AP与AC关联，完成CAPWAP隧道建立。包括数据隧道和控制隧道：  
数据隧道：AP接收的业务数据报文经过CAPWAP数据隧道集中到AC上转发。  
控制隧道：通过CAPWAP控制隧道实现AP与AC之间的管理报文的交互。
```

![Exported image](Exported%20image%2020251206145905-1.png)  

```
AP与AC关联，完成CAPWAP隧道建立  
包括数据隧道和控制隧道：  
数据隧道：  
AP接收的业务数据报文经过CAPWAP数据隧道集中到AC上转发。  
同时还可以选择对数据隧道进行数据传输层安全DTLS（Datagram Transport Layer Security）加密，  
使能DTLS加密功能后，CAPWAP数据报文都会经过DTLS加解密。  
控制隧道：  
通过CAPWAP控制隧道实现AP与AC之间的管理报文的交互。  
同时还可以选择对控制隧道进行数据传输层安全DTLS加密，使能DTLS加密功能后，CAPWAP控制报文都会经过DTLS加解密。
```

![Exported image](Exported%20image%2020251206145906-2.png)   
```
3.AP接入控制：  
AP发现AC后，会发送Join Request报文。AC收到后会判断是否允许该AP接入，并响应Join Response报文。  
AC上支持三种对AP的认证方式：MAC认证、序列号（SN）认证和不认证。
```

![Exported image](../../../Exported%20image%2020251206145908-3.octet-stream)  

```
4.数据隧道维持：  
AP与AC之间交互Keepalive报文来检测数据隧道的连通状态。  
控制隧道维持：AP与AC交互Echo报文来检测控制隧道的连通状态。
```

![Exported image](Exported%20image%2020251206145910-4.png)   
```
WLAN工作流程：步骤2  
WLAN业务配置下发：  
AC向AP发送Configuration Update Request请求消息，AP回应Configuration Update Response消息，AC再将AP的业  
务配置信息下发给AP。
```
 
```
1.SSID模板：主要用于配置WLAN网络的SSID名称，还可以配置其他功能，主要包括如下功能：  
隐藏SSID功能：  
用户在创建无线网络时，为了保护无线网络的安全，可以对无线网络名称进行隐藏设置。  
这样，只有知道网络名称的无线用户才能连接到这个无线网络中。  
单个VAP下能够关联成功的最大用户数：  
单个VAP下接入的用户数越多，每个用户能够使用的平均网络资源就越少，为了保证用户的上网体验，可以根据实际的网络状况配置合理的最大用户接入数。  
用户数达到最大时自动隐藏SSID的功能：  
使能用户数达到最大时自动隐藏SSID的功能后，当WLAN网络下接入的用户数达到最大时，SSID会被隐藏，新用户将无法搜索到SSID。
```
 
```
2.安全模板：  
配置WLAN安全策略，可以对无线终端进行身份验证，对用户的报文进行加密，保护WLAN网络和用户的安全。  
WLAN安全策略支持开放认证、WEP、WPA/WPA2-PSK、WPA/WPA2-802.1X等，在安全模板中选择其中一种进行配置。  
3.VAP模板：  
通过配置VAP模板下的参数，使AP实现为STA提供不同无线业务服务的能力。  
VAP模板能够引用：  
SSID模板和安全模板。
```
 ![Exported image](Exported%20image%2020251206145912-5.png)  

```
WLAN工作流程：步骤3  
STA接入  
CAPWAP隧道建立完成后，用户就可以接入无线网络。  
STA接入过程分为六个阶段：扫描阶段、链路认证阶段、关联阶段、接入认证阶段、DHCP、用户认证。
```
 
```
1.扫描阶段  
STA可以通过主动扫描，定期搜索周围的无线网络，获取到周围的无线网络信息。  
根据Probe Request帧（探测请求帧）是否携带SSID，可以将主动扫描分为两种：  
1.携带空SSID的主动扫描方式：
```

![Exported image](../../../Exported%20image%2020251206145914-6.octet-stream)

```
客户端发送广播Probe Request，客户端会定期地在其支持的信道列表中，发送Probe Request帧扫描无线网络。当AP收到Probe Request帧后，会回应Probe Response帧通告可以提供的无线网络信息。
```
 
```
2.携带有指定SSID的主动扫描方式：
```

![Exported image](../../../Exported%20image%2020251206145916-7.octet-stream)

```
客户端发送携带有指定SSID的Probe Request：STA依次在每个信道发出Probe Request帧，寻找与STA有相同SSID的AP，只有能够提供指定SSID无线服务的AP接收到该探测请求后才回复探查响应。
```
 
```
2.链路认证阶段  
为了保证无线链路的安全，接入过程中AP需要完成对STA的认证。802.11链路定义了两种认证机制：开放系统认证和共享密钥认证。
```

![Exported image](Exported%20image%2020251206145921-8.png)  

```
3.关联阶段  
完成链路认证后，STA会继续发起链路服务协商，具体的协商通过Association报文实现。终端关联过程实质上就是链路服务协商的过程，协商内容包括：支持的速率、信道等。
```

![Exported image](../../../Exported%20image%2020251206145922-9.octet-stream)  

```
4.接入认证  
接入认证即对用户进行区分，并在用户访问网络之前限制其访问权限。相对于链路认证，接入认证安全性更高。  
主要包含：PSK认证和802.1X认证。
```

![Exported image](Exported%20image%2020251206145924-10.png)  

```
5.DHCP  
STA获取到自身的IP地址，是STA正常上线的前提条件。如果STA是通过DHCP方式获取IP地址，可以用AC设备或汇聚交换机作为DHCP服务器为STA分配IP地址。  
一般情况下使用汇聚交换机作为DHCP服务器。
```

![Exported image](Exported%20image%2020251206145925-11.png)  

```
6.用户认证  
用户认证是一种“端到端”的安全结构，包括：802.1X认证、MAC认证和PoR1l认证。
```
 ![Exported image](Exported%20image%2020251206145927-12.png)  

```
WLAN工作流程：步骤4  
WLAN业务数据转发：  
CAPWAP中的数据包括控制报文（管理报文）和数据报文。  
控制报文是通过CAPWAP的控制隧道转发的；用户的数据报文分为隧道转发（又称为“集中转发”）方式和直接转发（又称为“本地转发”）方式。
```

![Exported image](Exported%20image%2020251206145929-13.png)  

![Exported image](Exported%20image%2020251206145931-14.png) ![Exported image](Exported%20image%2020251206145936-15.png)
 
![Exported image](Exported%20image%2020251206145937-16.png)