```
网络部署中为了防止单网关故障导致网络访问中断，部署多台设备作为网关￼￼虽然部署了多设备作为终端的网关，但是终端的网关地址不能任意切换，所以地址信息不变，无法完成网关设备的替换￼
```

```
VRRP：虚拟路由冗余协议（多虚一的技术）（Virtual Router Redundancy Protocol）虚拟路由冗余协议  
           将多台三层设备，虚拟为一台逻辑上的路由设备（作为网关）
```

```
VRRP基本概念：  
***VRRP必须在设备的同网段下，才能配置  
1.VRRP组  
   在一个组内的三层设备，可以执行虚拟化变为逻辑上的一台路由设备  
   管理员手工为每一台三层设备配置VRRP组  
   一个VRRP组中只能出现一台虚拟路由器
```
 
```
2.虚拟路由器：通过VRRP在组内构建的一个虚拟设备  
     
3.虚拟设备地址信息：  
   1.虚拟IP地址：管理员手工配置（是可以配置多个的）  
   2.虚拟MAC地址：自动生成（0000-5e00-01xx）xx是vrrp组的ID值
```
 
```
4.vrrp组内设备的类型  
   *通过为vrrp设备配置优先级值优选主备设备  
    优先级值越大越优先（默认值为100）（配置的值为\<1-254\>，取值的范围是0-255）  
        优先级值0：主设备退出VRRP组时，会通告优先级值为0的报文  
                   备设备收到优先级值为0的报文，会直接升为主设备，不需要等待master_down  
        优先级值255：虚拟IP地址拥有者（虚拟IP地址和设备物理接口IP地址相同）  
                   虚拟地址拥有者的设备一定会成为该组内的主设备  
                   虚拟地址拥有者的设备优先级值无法通过配置更改
```
 
```
**优先级值相等，则比较IP地址，优先IP地址大的
```
 
```
 对于选举比较的参数，只有优先级值可以直接决定主备设备  
 如果网络中已经存在主设备，且自身的优先级值和主设备相等，则不会进行比较IP地址  
1.master设备：  
      1.访问虚拟设备的数据，主设备会进行处理  
      2.周期性通告VRRP报文，在组内维护主的状态  
2.backup设备：  
      1.备设备检测主设备，当主设备失效，备设备成为主设备
```

```
组播地址：￼224.0.0.1 给所有节点发包  
224.0.0.2 给所有路由器节点发包
```
 
```
224.0.0.5/6 OSPF组播		MAC 01-00-5E-00-00-5/6     
224.0.0.18 VRRP			MAC 01-00-5E-00-00-12 （对应10进制转换为16进制）  
10010 = 18
```

```
VRRP主备切换：  
1.当主设备失效，备设备如何切换为主设备？  
   主设备会周期1s通告VRRP报文  
   备设备在周期时间内没有收到主设备的VRRP报文，则认为主设备失效  
          备设备运行master_down定时器，在定时器超时后认为主失效  
   master_down定时器：=（3* VRRP报文的周期通告时间1s）+ Skew_time（偏移时间）  大概为3.6s  
   其中，Skew_Time=（256–自身的优先级值）/256
```
 
```
2.下行交换机如何切换？  
   1.成为主设备时会发送免费arp报文 刷新下行交换机的mac地址表项  
   2.成为主设备后周期的发送免费arp报文 刷新下行交换机的mac地址表项
```

```
VRRP链路状态同步：￼对于vrrp组的切换，在上行故障后，不会影响下行链路建立的VRRP组  
会导致主设备的上行链路无法访问，备设备的上行链路正常访问  
而终端因为vrrp组没有切换所有，还是通过主设备进行数据访问  
最终导致业务无法正常通信
```
 
```
解决办法：通过检测链路，来实现自动调节VRRP组的主备选举  
[AR1-GigabitEthernet0/0/0]vrrp vrid 1 track interface GigabitEthernet 0/0/1 reduced 30  
                          在主设备上检测上行链路，如果故障则降低设备地优先级值变为备设备
```
 
```
在故障链路恢复后，设备的状态会自动切换为主设备  
但是主设备还没有建立IGP的邻居关系，导致不存在目标的路由信息，造成数据丢包  
（或者是主设备上行链路震荡，导致主备关系不断的切换，无法正常转发数据）
```
 
```
解决办法：  
1.主设备失效恢复后，不进行主设备的抢占  
  [AR1-GigabitEthernet0/0/0]vrrp vrid 1 preempt-mode disable   关闭VRRP的抢占模式
```
 
```
2.为主设备设置抢占延迟的时间（最好）  
  [AR1-GigabitEthernet0/0/0]vrrp vrid  1 preempt-mode timer delay 120  
```

```
在VRRP主备切换过程中，可以通过检测直连接口的形式将故障时间缩减在毫秒级范围内  
如果不是直连故障：  
 1.下行链路非直连故障，在master_down定时器超时后，可以完成收敛  
 2.上行链路非直连故障，无法完成切换
```
 
```
VRRP可以通过其他协议的检测来实现毫秒级的故障收敛
```

```
VRRP的负载分担：  
1.在同一个网段内部署多个VRRP组  
2.每个组内构建的虚拟IP地址作为终端的网关  
3.均匀为终端分配虚拟IP地址
```