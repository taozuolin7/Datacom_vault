# 跨域MPLS-VPN 基础
**MPLS VPN 跨域**  
MPLS VPN 跨域所谓的域指的就是 AS，AS 是自治系统，也就可以理解为本站点管理员能够管理的、配置的一个范围。
## **跨域就是两个站点之间要运行 MPLS VPN 技术，则会面临到以下问题:**  
1==.PE 与 PE 之间无法直接建立 VPNv4 邻居关系==，原因是因为 AS 之间不会运行IGP 协议，就会导致双方 AS 站点缺少去往对方 PE 的路由信息，本端 PE 不知道如何去往对端 PE，对端 PE 不知道如何去往本端PE，那我们之间的 BGP 邻居关系就建立不起来，BGP 邻居关系建立不起来就无法完成 VPNV4 路由信息的传递，从而导致访问异常。
2.还是由于缺少 IGP 的问题，会让 AS 之间无法通过 IGP 学习到对方 PE 的环回口路由信息，==那么就无法通过 LDP 去分配完整的公网标签了==，默认情况下 ASBR 之间会出现标签断裂的情况，就会导致标签转发业务异常。
 
==四个跨域的解决方案:optionabc1 c2 实际上就是把上述两个问题换了四种方式去解决。==

### **OptionA 方案:**  
OptionA 采用 ASBR 之间背靠背的解决方案  
1.本端 ASBR 把对方 ASBR 当作自己的一台 CE 设备时，PE-CE 侧一般传递的都是 IPV4 路由，所以==ASBR-ASBR 之间传递的也是普通IPv4 ==路由。  
双方 ASBR 都把自己当作大哥(PE设备)，把对方当作小弟 CE 设备。  
背靠背的模式  
优势:  
配置简单，思路清晰，适合网络业务规模不大的场景，他基本上就是你会做单域的方案，就可以做
**OptionA劣势:**
1.ASBR 需要创建大量的 VPN 实例，并且需要在 ASBR 之间创建大量的接口(虽然可以用虚拟接口如子接口，但是配置维护很麻烦了)  
2.ASBR 上需要存放大量的 VPNV4 路由。  
3.AS 越多维护起来越麻烦。

### **OptionB 方案:**  
只需要在 ASBR 与 ASBR 之间创建一个 VPNV4 的邻居关系,然后关闭掉==ASBR ==上针对于 policy vpn-target 的配置,并且记得在 ASBR 之间开启 MPLS 功能就 ok 了。 
在 OptionB 方案中，公网标签的作用是找到本 AS 的 ASBR 设备
**私网标签的作用是:** 
1.让本端 ASBR 设备能够通过这个标签找到对方 ASBR 设备  
2.让对方 PE 设备知道该数据包应该转发到哪个 VPN 实例中。  
优点:不用像 optionA 一样，在 ASBR 上创建大量 VPN 实例，接口去增大配置量和维护难度，只需要在ASBR 之间将 VPNV4 做好即可  
==缺点:ASBR 仍然维护了大量的 VPNV4 路由==。

### **OptionC方案**  
就是不依靠 ASBR 去存放路由了，只需要让 PE与 PE 之间建立 VPNV4 邻居关系，直接传递路由即可。  
C1 方案的三层标签:  
公网标签:去往本端 ASBR 的标签  
跨域标签:去往对端 PE的标签  
私网标签:去往对端 site 的标签

**注：**  
==**在BGP中：带标签的路由，在传递时，下一跳会自动改变**== 
vpn-instance本地隔离不通路由
RD使能远端能够区分不同路由
RT 谁来接收路由
私网标签，在接收端来区分谁来接收路由
 
**进一步解释：**
**1. 控制平面（RT 值的核心作用）**  
    控制平面的核心是 “决定哪些路由可以进入 VPN”，而 RT 值就是这个决策的关键依据。
当 PE 设备通过 MP-BGP 发布 VPN 路由时，会给路由打上 “Export RT” 标签，相当于给路由 “盖章”，标识它属于哪个 VPN 的 “出口”。
对端 PE 设备收到路由后，会检查自身 VRF 配置的 “Import RT”，如果与路由携带的 Export RT 匹配，就允许该路由进入本地 VPN 的路由表（VRF 表）；不匹配则丢弃。  
简单说，RT 值就像 “门禁卡”，控制路由能否 “进入” 特定 VPN。

**2. 转发平面（私网标签的核心作用）** 
    转发平面的核心是 “已经确定的路由，如何快速准确地传递数据”，私网标签就是数据转发的 “路标”。
当 PE 设备确定某条路由属于某个 VPN 后，会为该路由分配一个私网标签（也叫 VPN 标签），并将 “标签 + 路由” 的对应关系存入 LFIB（标签转发信息库）。
数据转发时，PE 设备会根据目的地址匹配对应的私网标签，将标签压入 MPLS 报文头部，后续设备只需根据标签快速转发，无需再解析 IP 地址（这也是 MPLS “快速转发” 的核心）。
当数据到达对端 PE 时，私网标签被弹出，设备根据标签对应的 VRF，将数据转发给正确的 CE 设备。  
简单说，私网标签就像 “快递面单上的分拣码”，指导数据在 MPLS 网络中高效传递到目标 VPN。

**总结：**
- 控制平面（RT）：解决 “路由能否加入 VPN” 的问题，确保 VPN 路由的隔离性和正确性。
- 转发平面（私网标签）：解决 “数据如何快速到达目标 VPN” 的问题，确保转发效率和准确性。