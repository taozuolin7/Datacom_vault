集中式网关：通过spine或GW leaf做所有终端的三层网关
分布式网关：将三层下沉给到leaf节点（二层网关）

**evpn 分布式网关的通信RT值匹配：**
同租户下：
1.同一个leaf设备下
   1.同子网通信：站点内通信，不需要任何配置
   2.不同子网通信：只需要将网关配置完成即可
2.不同leaf设备下
   1.同子网通信：本端BD域中RT值，和对端BD域中的RT值相互匹配（通过type2的MAC路由相互通信）
   2.不同子网通信：本端BD域中RT值，和对端BD域中的RT值相互匹配（通过type2的MAC路由相互通信）

不同租户下：
1.同一个leaf设备下（类似于集中式网关）
   1.同子网通信：不存在该场景
   2.不同子网通信：
        1.本端VPN实例下的RT值和对端VPN实例下的RT值相互匹配，通过VPNv4路由实现相互通信
       *2.本端VPN实例下的evpn RT值和对端VPN实例下的evpn RT值相互匹配，可以构建出type5路由，但是无法加入到VPN实例路由表中         
2.不同leaf设备下
   1.同子网通信
        1.本端BD域中RT值，和对端BD域中的RT值相互匹配（通过type2的MAC路由相互通信，要求两端的VNI值必须相同）
       *2.本端VPN实例下的EIRT和对端BD域下的ERT值匹配（可以通过type2的ARP路由相互传递，无法将路由加入实例路由表中）
       *3.本端VPN实例下的Evpn RT和对端VPN实例下的Evpn RT值匹配（可以通过type5路由相互传递，并且构建VxLAN隧道）
                                   （因为直连路由优于BGP路由，所以不会将该类型type5路由加入VPN实例的路由表中）
   2.不同子网通信：
        1.本端VPN实例下的EIRT值，和对端BD域中的ERT值匹配（通过type2的IRB路由相互通信）
        2.本端VPN实例下的Evpn RT值和对端VPN实例下的Evpn RT值匹配（可以通过type5路由构建vxlan隧道，并相互通信）

![](assets/5.VXLAN%20EVPN（分布式网关）/file-20251214154116374.png)
```
CE2：
#
bgp 100
 private-4-byte-as enable
 peer 1.1.1.1 as-number 100
 peer 1.1.1.1 connect-interface LoopBack0
 #
 ipv4-family unicast
  undo peer 1.1.1.1 enable
 #
 l2vpn-family evpn
  policy vpn-target
  peer 1.1.1.1 enable
#
interface Nve1
 source 2.2.2.2
 vni 10 head-end peer-list protocol bgp
#
bridge-domain 10
 vxlan vni 10
 #
 evpn
  route-distinguisher 10:10
  vpn-target 1:1 export-extcommunity
  vpn-target 1:1 import-extcommunity
#
interface GE1/0/1.1 mode l2
 encapsulation dot1q vid 10
 bridge-domain 10
#
```

```
CE1：
#
bgp 100
 private-4-byte-as enable
 peer 2.2.2.2 as-number 100
 peer 2.2.2.2 connect-interface LoopBack0
 peer 3.3.3.3 as-number 100
 peer 3.3.3.3 connect-interface LoopBack0
 #
 ipv4-family unicast
  undo peer 2.2.2.2 enable
  undo peer 3.3.3.3 enable
 #
 l2vpn-family evpn
  undo policy vpn-target
  peer 2.2.2.2 enable
  peer 2.2.2.2 reflect-client
  peer 3.3.3.3 enable
  peer 3.3.3.3 reflect-client
#
```

```
CE3：
#
bgp 100
 private-4-byte-as enable
 peer 1.1.1.1 as-number 100
 peer 1.1.1.1 connect-interface LoopBack0
 #
 ipv4-family unicast
  undo peer 1.1.1.1 enable
 #
 l2vpn-family evpn
  policy vpn-target
  peer 1.1.1.1 enable
#
interface Nve1
 source 3.3.3.3
 vni 10 head-end peer-list protocol bgp
#
bridge-domain 10
 vxlan vni 10
 #
 evpn
  route-distinguisher 10:10
  vpn-target 1:1 export-extcommunity
  vpn-target 1:1 import-extcommunity
#
interface GE1/0/1.1 mode l2
 encapsulation dot1q vid 10
 bridge-domain 10
#
```
**该配置完成后，可以实现同子网的通信**
[CE2]dis bgp evpn all routing-table 
```
 Route Distinguisher: 10:10
       Network(EthTagId/MacAddrLen/MacAddr/IpAddrLen/IpAddr)  NextHop                  
 *>    0:48:246c-4f27-5afc:0:0.0.0.0                          0.0.0.0     
 *>i   0:48:80e4-a99f-c673:0:0.0.0.0                          3.3.3.3 
```
bgp-evpn邻居之间交互了type2（mac路由）
同子网通信需要两端nve设备相互接收type2路由
通过BD域下evpn的RT值相互匹配接收type2路由

```
#
interface Vbdif10
 ip address 192.168.1.254 255.255.255.0
#
interface Vbdif20
 ip address 192.168.2.254 255.255.255.0
#
bridge-domain 10
 vxlan vni 10
 #
 evpn
  route-distinguisher 10:10
  vpn-target 1:1 export-extcommunity
  vpn-target 1:1 import-extcommunity
  vpn-target 3:3 import-extcommunity
#
```

```
#
interface Vbdif10
 ip address 192.168.1.254 255.255.255.0
#
interface Vbdif20
 ip address 192.168.2.254 255.255.255.0
#
bridge-domain 20
 vxlan vni 20
 #
 evpn
  route-distinguisher 20:20
  vpn-target 3:3 export-extcommunity
  vpn-target 3:3 import-extcommunity
  vpn-target 1:1 import-extcommunity
#
```
完成该配置后可以实现，不同leaf下不同子网通信
通过BD域下evpn的RT值相互匹配接收type2路由（MAC路由）
*如果是同leaf下不同子网通信，则只需要配置网关即可

# 不同租户 不同leaf的不同网段的互访  第一种方式
构建的VxLAN是通过type3路由实现的
而type3路由是通过本端BD域的ERT
被对端VPN实例下的EIRT匹配的
对于type2 IRB路由信息的传递：
会携带本端BD域中的ERT、二层VNI、三层VNI
对于type2 IRB路由信息的接收：
本端VPN实例下的EIRT匹配接收type2的IRB路由
对于type2 IRB路由信息的加表：
会以32位主机的路由信息做添加
对于数据信息的访问：
数据在访问时封装三层VNI的值
路由表中的路由信息：
```
    Destination/Mask     Proto   Pre  Cost        Flags NextHop    Interface
    192.168.2.4/32       IBGP    255  0             RD  3.3.3.3     VXLAN
```
```
CE2：
#
bridge-domain 10
 vxlan vni 10
 #
 evpn
  route-distinguisher 1:1
  vpn-target 1:1 export-extcommunity
#
ip vpn-instance A
 ipv4-family
  route-distinguisher 10:10
  vpn-target 2:2 import-extcommunity evpn
 vxlan vni 5000
#
interface Vbdif10
 ip binding vpn-instance A
 ip address 192.168.1.254 255.255.255.0
 vxlan anycast-gateway enable
 arp collect host enable
#
```
```
CE3：
#
bridge-domain 20
 vxlan vni 20
 #
 evpn
  route-distinguisher 2:2
  vpn-target 2:2 export-extcommunity
#
ip vpn-instance B
 ipv4-family
  route-distinguisher 20:20
  vpn-target 1:1 import-extcommunity evpn
 vxlan vni 5001
#
interface Vbdif20
 ip binding vpn-instance B
 ip address 192.168.2.254 255.255.255.0
 vxlan anycast-gateway enable
 arp collect host enable
#
```
# 不同租户，不同leaf的同子网通信
特殊情况：
通过VPN实例的EIRT和EERT相互匹配
可以接收对方的type5路由
通过该type5路由的交互，可以构建VxLAN 隧道
```
CE2：
#
ip vpn-instance A
 ipv4-family
  route-distinguisher 100:100
  vpn-target 100:1 export-extcommunity
  vpn-target 100:1 import-extcommunity
#
bridge-domain 10
 vxlan vni 10
 #
 evpn
  route-distinguisher 10:10
  vpn-target 1:3 export-extcommunity
  vpn-target 1:3 import-extcommunity
#
interface Vbdif10
 ip binding vpn-instance A
 ip address 192.168.1.254 255.255.255.0
 vxlan anycast-gateway enable
 arp collect host enable
#
CE2：
#
interface Nve1
 source 2.2.2.2
 vni 10 head-end peer-list protocol bgp
#
bridge-domain 10
 vxlan vni 10
 #
 evpn
  route-distinguisher 10:10
  vpn-target 1:1 export-extcommunity
#
ip vpn-instance A
 ipv4-family
  route-distinguisher 100:100
  vpn-target 100:300 import-extcommunity evpn
  vpn-target 100:300 export-extcommunity evpn
 vxlan vni 5000
#
interface Vbdif10
 ip binding vpn-instance A
 ip address 192.168.1.254 255.255.255.0
 vxlan anycast-gateway enable
 arp collect host enable
#
interface GE1/0/1.1 mode l2
 encapsulation dot1q vid 10
 bridge-domain 10
#
```


```
CE3：
#
ip vpn-instance B
 ipv4-family
  route-distinguisher 100:300
  vpn-target 100:3 export-extcommunity
  vpn-target 100:3 import-extcommunity
#
bridge-domain 10
 vxlan vni 10
 #
 evpn
  route-distinguisher 30:30
  vpn-target 1:3 export-extcommunity
  vpn-target 1:3 import-extcommunity
#
interface Vbdif10
 ip binding vpn-instance B
 ip address 192.168.1.254 255.255.255.0
 vxlan anycast-gateway enable
 arp collect host enable
#
CE3：
#
interface Nve1
 source 3.3.3.3
 vni 20 head-end peer-list protocol bgp
#
bridge-domain 20
 vxlan vni 20
 #
 evpn
  route-distinguisher 20:20
  vpn-target 2:2 export-extcommunity
#
ip vpn-instance C
 ipv4-family
  route-distinguisher 300:300
  vpn-target 100:300 import-extcommunity evpn
  vpn-target 100:300 export-extcommunity evpn
 vxlan vni 5001
#
interface Vbdif20
 ip binding vpn-instance C
 ip address 192.168.1.254 255.255.255.0
 vxlan anycast-gateway enable
 arp collect host enable
#
interface GE1/0/1.1 mode l2
 encapsulation dot1q vid 10
 bridge-domain 20
#
```
# 不同租户，同leaf下，不同子网通信
## 第一种通信方式：
因为VPN实例的RT值相互匹配
所以可以通过MP-BGP通告路由相互接收
CE2：
bgp 100
 #
 ipv4-family vpn-instance A
  import-route direct
 #
 ipv4-family vpn-instance B
  import-route direct
```
CE2：
#
bridge-domain 10
 vxlan vni 10
 #
 evpn
  route-distinguisher 10:20
  vpn-target 1:2 export-extcommunity
  vpn-target 1:2 import-extcommunity
#
bridge-domain 20
 vxlan vni 20
 #
 evpn
  route-distinguisher 20:10
  vpn-target 1:2 export-extcommunity
  vpn-target 1:2 import-extcommunity
#
ip vpn-instance A
 ipv4-family
  route-distinguisher 100:200
  vpn-target 100:200 export-extcommunity
  vpn-target 100:200 import-extcommunity
#
ip vpn-instance B
 ipv4-family    
  route-distinguisher 200:100
  vpn-target 100:200 export-extcommunity
  vpn-target 100:200 import-extcommunity
#
```

```
CE2：
#
interface Vbdif10
 ip binding vpn-instance A
 ip address 192.168.1.254 255.255.255.0
 vxlan anycast-gateway enable
 arp collect host enable
#
interface Vbdif20
 ip binding vpn-instance B
 ip address 192.168.2.254 255.255.255.0
 vxlan anycast-gateway enable
 arp collect host enable
#
interface GE1/0/1.1 mode l2
 encapsulation dot1q vid 10
 bridge-domain 10
#
interface GE1/0/1.2 mode l2
 encapsulation dot1q vid 20
 bridge-domain 20
#
```

## 第二种通信方式：
通过VPN实例的Evpn RT相互匹配
可以通过type5路由相互交互各VPN实例的路由
*type5路由可以正常构建，但是无法相互加入VPN实例路由表
CE2：
bgp 100
 #
 ipv4-family vpn-instance A
  import-route direct
  advertise l2vpn evpn
 #
 ipv4-family vpn-instance B
  import-route direct
  advertise l2vpn evpn
 #
 ```
 CE2：
#
bridge-domain 10
 vxlan vni 10
 #
 evpn
  route-distinguisher 10:20
  vpn-target 1:2 export-extcommunity
  vpn-target 1:2 import-extcommunity
#
bridge-domain 20
 vxlan vni 20
 #
 evpn
  route-distinguisher 20:10
  vpn-target 1:2 export-extcommunity
  vpn-target 1:2 import-extcommunity
#
ip vpn-instance A
 ipv4-family
  route-distinguisher 100:200
  vpn-target 10:20 export-extcommunity evpn
  vpn-target 10:20 import-extcommunity evpn
 vxlan vni 5000
#
ip vpn-instance B
 ipv4-family
  route-distinguisher 200:100
  vpn-target 10:20 export-extcommunity evpn
  vpn-target 10:20 import-extcommunity evpn
 vxlan vni 5001
#
 ```
```
CE2：
#
interface Vbdif10
 ip binding vpn-instance A
 ip address 192.168.1.254 255.255.255.0
 vxlan anycast-gateway enable
 arp collect host enable
#
interface Vbdif20
 ip binding vpn-instance B
 ip address 192.168.2.254 255.255.255.0
 vxlan anycast-gateway enable
 arp collect host enable
#
interface GE1/0/1.1 mode l2
 encapsulation dot1q vid 10
 bridge-domain 10
#
interface GE1/0/1.2 mode l2
 encapsulation dot1q vid 20
 bridge-domain 20
#
```

# 不同租户 不同leaf的不同网段的互访  第二种方式
构建的VxLAN是通过type5路由实现的
而type5路由是通过本端VPN实例下的EERT
被对端VPN实例下的EIRT匹配的

对于type5路由信息的传递：
会携带本端BD域中的ERT、三层VNI

对于type5路由信息的接收：
本端VPN实例下的EIRT匹配接收type5路由

对于type5路由信息的加表：
直接将type5的路由信息做添加

对于数据信息的访问：
数据在访问时封装三层VNI的值

```
CE2：
#
bridge-domain 10
 vxlan vni 10
 #
 evpn
  route-distinguisher 1:1
  vpn-target 1:1 export-extcommunity
#
ip vpn-instance A
 ipv4-family
  route-distinguisher 10:10
  vpn-target 10:20 import-extcommunity evpn
  vpn-target 10:20 export-extcommunity evpn
 vxlan vni 5000
#
interface Vbdif10
 ip binding vpn-instance A
 ip address 192.168.1.254 255.255.255.0
 vxlan anycast-gateway enable
 arp collect host enable
#
bgp 100
 #
 ipv4-family vpn-instance A
  import-route direct
  advertise l2vpn evpn
#
```

```
CE3：
#
bridge-domain 20
 vxlan vni 20
 #
 evpn
  route-distinguisher 2:2
  vpn-target 2:2 export-extcommunity
#
ip vpn-instance B
 ipv4-family
  route-distinguisher 20:20
  vpn-target 10:20 import-extcommunity evpn
  vpn-target 10:20 export-extcommunity evpn
 vxlan vni 5001
#
interface Vbdif20
 ip binding vpn-instance B
 ip address 192.168.2.254 255.255.255.0
 vxlan anycast-gateway enable
 arp collect host enable
#
bgp 100
 #
 ipv4-family vpn-instance B
  import-route direct
  advertise l2vpn evpn
#
```