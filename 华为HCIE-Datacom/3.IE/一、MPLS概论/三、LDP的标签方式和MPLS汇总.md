**LDP ID 和 LSP ID**  
LDP ID由 LSP ID 和 标签空间标识符 组成  
LSP ID长度为32bit  
标签空间标识符16bit
 
LDP的标签空间：  
1.值为0 （默认的）：表示基于设备（或基于平台）的标签空间  
标签在设备上基于不同的FEC是唯一的  
标签在转发时只依赖标签进行转发  
2.值为非0：表示基于接口的标签空间  
标签在不同的接口上基于不同的FEC可以分配相同的标签  
标签在转发时根据标签值和入接口进行转发

**LDP的标签发布：**  
标签分发是由下游设备给上游设备的  
在数据访问的方向上，源设备是上游，目标设备是下游
 
1.标签的发布方式  
1.下游自主的方式（DU）  
无需上游的LSR设备发送标签请求消息，下游LSR自动根据一条FEC，向上游进行标签的分发  
2.下游按需的方式（DoD）  
上游LSR对于一条FEC需要向下游设备发送请求消息，下游LSR收到请求消息后 会向上游进行标签的分发
 
2.标签的控制方式  
1.独立的方式  
本地LSR不需要收到下游LSR设备分配的标签，自主的为一条FEC分配一个标签  
DU + 独立 ：本地LSR设备不需要存在下游LSR给的标签信息，会直接向上游分配一个标签  
DoD+ 独立 ：本地LSR不需要收到下游LSR分配的标签，自主的为一条FEC分配一个标签，但是需要接收到上游设备发送的请求消息，才会进行标签的分发  
2.有序的方式  
本地LSR需要收到下游LSR设备分配的标签，才能为一条FEC分配一个标签  
DU + 有序：本地LSR需要收到下游LSR设备分配的标签，才能为一条FEC分配一个标签，并将标签发布给上游设备  
DoD+ 有序：本地LSR需要收到下游LSR设备分配的标签，才能为一条FEC分配一个标签，但是需要接收到上游设备发送的请求消息，才会进行标签的分发
 
3.标签的保持方式  
1.自由的方式  
对于从邻居收到的标签信息，不管是不是最优的下一跳，都会进行保留（保留的可以充当备份使用）  
2.保守的方式  
对于从邻居收到的标签信息，只保留最优的下一跳
 
*华为的默认标签方式： DU（为了更加快速的标签分配） + 有序（为了防止出现LSP的不完整） + 自由（LSP保留备份，用于故障切换）  
华为最快的标签方式：DU + 独立 + 自由（但是该方式的组合 容易出现LSP的断裂）

**[AR1]dis mpls lsp 查看MPLS的LSP信息**  
FEC In/Out Label In/Out IF
 
该LSP的信息分类：  
1.自身的FEC：  
只存在入标签（3），不存在出标签 ，也不存在出入接口 （此类信息设备作为egress节点）  
***作为egress节点，为自身的FEC产生入标签，并将标签发布给上游设备，作为上游设备的出标签  
2.其他的FEC  
只存在出标签，不存在入标签，不存在入接口存在出接口（此类信息设备作为ingress节点）  
***对应出标签的值是下游设备分配的值
 
存在入标签，也存在出标签，不存在入接口存在出接口（此类信息设备作为transit节点）  
***对应入标签是设备自身产生的，并发布给上游；出标签是下游设备分配得到的

**LDP默认只为32位主机路由分配标签信息**  
\<AR1\>dis mpls ldp lsp 查看所有FEC生成的标签值  
DestAddress/Mask In/OutLabel UpstreamPeer NextHop OutInterface  
上游邻居
 
对于非32位的主机路由，只会将标签使用自由的方式进行保留，不会为其产生入标签（也不会发布给上游设备）  
对于学习到32位的标签信息，如果不存在对应的32位主机路由，则只会将出标签使用自由的方式进行保留，  
不会为其产生入标签（也不会发布给上游设备）

对于FEC标签分发的指定：  
[AR1-mpls]lsp-trigger 该方式指定那些FEC进行标签的分配（只针对本设备有效）  
all 对于自身直连路由条目进行标签的分配  
bgp-label-route 对于BGP路由引入到IGP后进行标签的分配  
host 默认的方式，为自身主机路由进行标签的分配  
ip-prefix 通过前缀列表指定自身路由进行标签的分配（对于指定的路由条目可以作为egress点，没有指定路由条目只能作为transit）  
none 该方式下，设备仅作为transit节点，不会作为ingress 和 egress使用

LDP的总结：对于一个设备的标签转发来说  
1.所有的入标签，一定不同  
2.对于相同的路由（下一跳也相同），出标签，一定相同  
3.对于相同的路由（下一跳不相同），出标签，可能相同  
4.对于不同的路由（下一跳相同），出标签，一定不同  
5.对于不同的路由（下一跳不相同），出标签，可能相同  
6.对于同一条FEC，入标签和出标签是可能相同的

**PHP：次末跳弹出**  
当transit节点收到入标签要替换为出标签3时，执行PHP  
将标签剥离，给最后一条设备发送IP报文
 
减轻最后一跳设备的处理压力
 
[AR4-mpls]label advertise  
explicit-null 显示空标签  
implicit-null 隐式空标签  
non-null 正常分配标签（标签大于16）

![Exported image](Exported%20image%2020251206151153-0.png)

**MPLS的汇总：**  
当一条32位主机路由，被transit节点执行了汇总(一般是ABR)，变为24位的网段路由，那么该FEC是否会存在对应的LSP？数据是否能够通信？  
该FEC不存在对应的LSP了，数据依然能访问通信  
汇总后的路由，对于LSP的影响？  
会产生LSP的断裂
 
对于LSP断裂后如何实现数据的通信？  
断裂后通过IP报文实现通信，没有断裂的 依然通过MPLS标签通信
 
如何解决LSP的断裂？  
LSP断裂的本质是因为LSR设备没有明细的32位主机路由  
1.为汇总后的每一台设备都配置静态的32位路由  
2.为汇总后每一台设备都开启最长掩码匹配的功能 [AR2-mpls-ldp]longest-match [AR1-mpls-ldp]longest-match   设备收到下游分发的标签值，如果自身不存在对应的32位主机路由，设备会通过自由的方式进行标签的保留  
longest-match 设备激活该功能，会将自由保留的FEC标签，变为正常使用的FEC标签（也可以正常向上游设备进行标签分配）  
但是该方式只是将LSP变得可用，后续的数据访问能否进入到LSP进行数据转发 还是要通过路由信息来决定  
如果该节点只作为中间节点，则不需要存在明细的路由信息  
如果该节点作为入节点，则必须存在明细的路由信息 [AR1]ip rou 100.4.4.4 32 10.1.12.2  
***作为入节点的设备配置的明细路由，是为了帮助数据进入隧道转发的

![Exported image](Exported%20image%2020251206151156-1.png) ![Exported image](Exported%20image%2020251206151159-2.png)

1.在AR4上通过：100.4.4.4 32 位的路由：

![Exported image](Exported%20image%2020251206151203-3.png)

￼然后在：AR1上查看lsp信息：

![Exported image](Exported%20image%2020251206151210-4.png)  

2.在AR3（ABR）上执行汇总：[R3-ospf-1-area-0.0.0.1]abr-summary 100.4.4.0 255.255.255.0  
后，在AR1的lsp表项中不存在100.4.4.4 的lsp条目

![Exported image](Exported%20image%2020251206151211-5.png)  

3.在AR1上通过最长匹配：[R1-mpls-ldp]longest-match ，开启最长匹配功能

![Exported image](Exported%20image%2020251206151214-6.png)