**LDP 默认只为IGP的 32位主机路由分配标签**
**MP-BGP 为私网路由分配标签**
**BGP 通过路由策略，为公网路由分配标签**

VPNv4路由： RD：IPv4：ETR：NH：Lable
标签IPv4 路由： IPv4 ：NH ：Lable
	![](assets/5.跨域VPN-OptionC1/file-20251229152814475.png)
C1方案的注意点：
1. 一个AS内部建立的使BGP邻居关系（unicast）
2. ASBR之间建立EBGP邻居关系（unicast）
3. 不同AS的PE建立MP-EBGP邻居关系（vpnv4）


C1的方案，目的是之间在站点PE之间建立MP-EBGP邻居（VPNv4邻居）
为此需要完成：
	1.在ASBR1上向对端EBGP邻居宣告（network）PE1的环回口路由
	2.针对该路由，使用route-policy 分配标签（BGP-LSP标签），再对邻居使能标签路由转发能力（label-route-capability）
	3.在ASBR2上通过使能标签路由转发能力（label-route-capability）接收该路由；为了使，从ASBR1学习到的邻居能够传递给PE2并且让传递给PE2的路由的下一跳自动变为ASBR2，需要对其传递来的==标签路由==，**重新分配标签，通告给RR**，RR也需要使能标签路由转发的功能。
	4.PE上对RR也需要使能（label-route-capability）接收该路由
	5.完成以上操作，那么两个AS中的PE就可以直接建立EBGP邻居。

PE之间建立EBGP邻居关系：
	1.注意ebgp-max-hop
	2.为了传递vpnv4路由，需要建立vpnv4邻居

注意点1：
在ASBR1上宣告（network）的PE1的路由，EBGP邻居学习到了，但是为什么IBGP邻居没有学习到呢？
	1.不是路由选路优先级的问题
    2.而是因为ASBR1再对ASBR2发来的 标签路由 进行替换的时候，route-policy pe export，默认拒绝了。



### 通过反射器RR建立VPNv4邻居
![](assets/5.跨域VPN-OptionC1/file-20251229173813148.png)


==一、OptionC1 方案为什么需要通过route-policy分配标签？==
1.我们的目标是 想要通过 ASBR将 PE或者RR的环回口路由传递给（network，import） 另外一个AS的 PE或者RR，让他们之间建立起 多跳MP-EBGP邻居。
2.由于 LDP 默认只为 IGP路由的 32位主机分配标签，因此：通过 BGP(network,import)的本端 PE或者RR的环回口路由 给 对端的 PE或者RR，此时无法构建 ==跨AS的 LSP== 路径。
3.如何构建 跨AS 的LSP 是 Option C1 方案的难点：
4.通过route-policy 从一段ASBR 到 另一端的 PE之间 构建这条 跨AS 的标签路径。
- 本端ASBR为，去往对端ASBR 的路由打上 公网标签，并pe 对端使能label-route-capbility，接口使能mpls
- 对端ASBR收到路由后，为该条路由重新分配公网标签，连接ASBR的接口使能mpls，并对本端RR是同route-policy 分配新标签，并且使能label-route-capbility。
- RR收到后，将该路由传递给PE，RR两个接口使能label-route-capbility
- PE针对RR的bgp 邻居使能 label-route-capbility
#OptionC1在ASBR上通过next-hop-local让两端PE建立起MP-EBGP邻居，后业务路由无法成为最优的原因
#### 1. **缺少公网标签，路由无法触发 MPLS 标签转发，只能降级为 IP 转发**

- Option C1 的核心是**标签转发**，PE 转发私网流量时依赖**标签栈**（私网标签由本地 PE 分配，公网标签由 ASBR 分配）。
- 若 ASBR 未通过`route-policy`分配公网标签，传递给 RR 和 PE 的 VPNv4 路由是**无标签路由**。此时 PE 无法生成标签栈，只能尝试通过**IP 转发**来匹配这条路由。
- 但公网是 MPLS 域，PE 与对端 PE 之间没有直连的 IP 可达性（公网路由依赖 LSP），IP 转发的路径开销远高于标签转发。根据 BGP 选路的**最小开销优先**原则，这条无标签路由会被判定为非最优。
#### 2. **`next-hop-local`仅修改下一跳，无法替代标签的转发属性**
- `next-hop-local`的作用是将 BGP 路由的下一跳修改为 ASBR 自身，让 RR 和 PE 能通过本地 AS 的公网 LSP 到达 ASBR。**但它不具备分配公网标签的功能**。
- PE 收到路由后，会检查路由的**标签属性**：对于 VPNv4 路由，标签是**必备转发属性**。无标签的 VPNv4 路由在 PE 的路由表中，会被标记为`no label`，其优先级低于**带标签的 VPNv4 路由**（如果存在其他路径，比如备份路径）。
- 即使没有其他路径，PE 也会认为这条无标签路由的**转发可行性低**（因为无法走高效的标签交换），从而不将其选为最优。
#### 3. **BGP 选路规则的优先级压制**
BGP 选路有严格的优先级顺序，其中与本问题相关的关键规则是：
1. **路由的有效性**：带标签的 VPNv4 路由，其转发路径是预先生成的 LSP，有效性高于依赖 IP 转发的无标签路由。
2. **下一跳可达性的质量**：`next-hop-local`修改后的下一跳是 ASBR，但如果 ASBR 与 PE 之间的公网 LSP 是基于标签的，而路由本身无标签，PE 会认为 “下一跳可达，但路由无法用标签转发”，从而降低这条路由的优先级。
3. **路由属性的完整性**：Option C1 要求 VPNv4 路由携带`MPLS Label`属性，缺少该属性的路由会被 BGP 协议判定为 “属性不完整”，优先级低于属性完整的路由。
#### 4. **RR 传递路由时的属性丢失风险**
如果 ASBR 向 RR 发布的是无标签 VPNv4 路由，RR 在反射路由时，可能会丢失部分关键属性（比如标签属性），导致 PE 收到的路由信息不完整。
- 正常情况下，RR 反射的是**带公网标签的 VPNv4 路由**，PE 能直接关联到公网 LSP；
- 若 RR 传递的是无标签路由，PE 无法关联到公网 LSP，只能将其作为普通 IP 路由处理，自然无法成为最优。


