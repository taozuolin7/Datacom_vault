```
PPP的概述：    
  1.PPP（Point-to-Point Protocol，点到点协议）是一种常见的广域网数据链路层协议，主要用于在全双工的链路上进行点到点的数据传输封装。  
  2.PPP提供了安全认证协议族  
PAP（Password Authentication Protocol，密码认证协议）  
CHAP（Challenge Handshake Authentication Protocol，挑战握手认证协议）。  
  3.PPP协议具有良好的扩展性，例如，当需要在以太网链路上承载PPP协议时，PPP可以扩展为PPPoE。  
  4.PPP协议提供LCP（Link Control Protocol，链路控制协议），用于各种链路层参数的协商，例如最大接收单元MRU，认证模式等。  
  5.PPP协议提供各种NCP（Network Control Protocol，网络控制协议），  
如IPCP（IP Control Protocol ，IP控制协议），用于各网络层参数的协商，更好地支持了网络层协议。￼  
PPP帧格式：
```

![Exported image](Exported%20image%2020251206142408-0.png)  

```
Flag字段标识一个物理帧的起始和结束，该字节为二进制序列01111110（0X7E）。  
PPP帧的Address字段字节固定为11111111 （0XFF），是一个广播地址。  
PPP数据帧的Control字段默认为00000011（0X03），表明为无序号帧。  
帧校验序列（FCS）字段是个16 bit的校验和，用于检查PPP帧的完整性。  
Protocol字段用来说明PPP所封装的协议报文类型，0XC021代表LCP报文，0XC023代表PAP报文，0XC223代表CHAP报文。  
Information字段包含Protocol字段中指定协议的内容，该字段的最大长度被称为最大接收单元MRU，缺省值为1500。  
当Protocol字段为0XC021时，Information结构如下：  
Identifier字段为1个字节，用来匹配请求和响应。  
Length域的值就是该LCP报文的总字节数据。  
Data字段则承载各种TLV（Type/Length/Value）参数用于协商配置选项，包括最大接收单元，认证协议等等。  
LCP报文携带的一些常见的配置参数有MRU、认证协议和魔术字。  
在VRP（Versatile Routing Platform，通用路由平台）平台上，MRU参数使用接口上配置的MTU（Maximum Transmission Unit，最大传输单元）值来表示。  
常用的PPP认证协议有PAP和CHAP，一条PPP链路的两端可以使用不同的认证协议认证对端，但是被认证方必须支持认证方要求使用的认证协议并正确配置用户名和密码等认证信息。  
LCP使用魔术字来检测链路环路和其他异常情况。魔术字是随机产生的一个数字，随机机制需要保证两端产生相同魔术字的可能性几乎为0。
```
   

```
PPP链路建立流程:  
PPP链路的建立有三个阶段的协商过程，链路层协商、认证协商（可选）和网络层协商。  
链路层协商：通过LCP报文进行链路参数协商，建立链路层连接。  
认证协商（可选）：通过链路建立阶段协商的认证方式进行链路认证。  
网络层协商 ：通过NCP协商来选择和配置一个网络层协议并进行网络层参数协商。￼
```

![Exported image](Exported%20image%2020251206142410-1.png)  

```
PPP协商时，先进行LCP的协商  
如果没有问题，则进行认证的协商  
（认证协商是可选的（可以跳过））  
如果认证协商没有问题 或 跳过了认证协商，则进行NCP协商￼PPP作为二层数据链路层的封装协议（不存在MAC地址）￼  
1、LCP协商：链路控制协议  
*就是进行链路层的信息协商  
 需要协商的参数有：  
  1.MRU：最大传输单元  
  2.认证字段：下一阶段是否进行认证协商  
  3.MT：多链路协商（是否为多链路捆绑）  
  4.魔术字：防环的  
   
**只要链路开启，就会自动进行协商
```

![Exported image](Exported%20image%2020251206142817-2.png)  

```
本端AR1发送request报文 携带协商参数  
 对端AR2收到request报文：  
   1.识别协商的信息，但是不认可参数  
        回复一个NAK报文，携带协商的信息并指定认可的参数值  
     AR1收到NAK报文，回复一个request报文，携带指定认可的参数  
   2.不识别协商的信息  
        回复一个rejected报文，携带不识别的参数  
    AR1收到rejected报文后，回复一个request报文，不携带对端不识别的信息  
    3.识别协商的信息，也认可参数值  
        AR1回复一个ACK报文，表示LCP协商通过
```

![Exported image](Exported%20image%2020251206142923-3.png)

```
￼[AR1]aaa  
[AR1-aaa]local-user test password cipher Huawei@123   
[AR1-aaa]local-user test service-type ppp  
[AR1]int Serial 1/0/0   
[AR1-Serial1/0/0]ppp authentication-mode chap     
# 只有认证端会选择认证的模式  
[AR1-Serial1/0/0]ppp chap user abc￼  
[AR2]aaa  
[AR2-aaa]local-user abc password cipher Huawei@123  
[AR2-aaa]local-user abc service-type ppp   
[AR2]interface Serial 1/0/0  
[AR2-Serial1/0/0]ppp chap user test
```

```
3、NCP协商：  
1.代替免费ARP，检测地址冲突  
2.代替ARP，不需要获取对端的MAC（PPP链路也不存在MAC地址）￼￼配置IP地址后的设备，AR1会发送一个request报文（携带自身的IP地址）  
AR2收到request报文后，要进行参数检测，判断报文携带的IP地址 和 自身是否相同  
   1.如果相同，则认为参数不合法，回复NAK报文  
   2.如果不同，则认为参数合法，回复ACK报文
```
 
```
静态NCP协商：手工配置IP地址  
   为设备两端配置IP地址，可以任意配置，只要保障两端地址不同即可  
   两端地址不同网段，也可以正常通信，主要原因是因为进行了NCP协商  
   NCP协商通过的地址参数，设备会自动为其添加一条32位直连的路由条目  
   为PPP添加的路由条目，只需要确保出接口是自身的serial接口即可（不需要指定下一跳）  
   [AR1]ip route-static 2.2.2.2 32 Serial 1/0/0 ￼  
动态NCP协商：自动获取IP地址  
   如果被认证端的地址，需要通过认证端获取  
   AR2会发送一个request报文（携带自身的IP地址 0.0.0.0 ）  
   AR1收到request报文后，要进行参数检测，判断报文携带的IP地址 和 自身是否相同  
   1.如果地址为0.0.0.0 ，则认为参数不合法，回复NAK报文（携带分配地址池中的一个地址）  
   AR2收到NAK报文后，使用报文内携带的地址参数，并重新发送一次request报文。
```

![Exported image](Exported%20image%2020251206142924-4.png)

```
￼[AR1]ip pool PPP   
[AR1-ip-pool-PPP]network 192.168.1.0 mask 24 
```
 
```
[AR1]interface Serial 1/0/0  
[AR1-Serial1/0/0]ip address 100.1.1.1 31  
[AR1-Serial1/0/0]remote address pool ppp￼  
[AR2]interface Serial 1/0/0  
[AR2-Serial1/0/0]ip address ppp-negotiate 
```

![Exported image](Exported%20image%2020251206143628-5.png)

```
￼PAP模式：  
[AR1]aaa  
[AR1-aaa]local-user test password cipher Huawei@123   
[AR1-aaa]local-user test service-type ppp  
[AR1]int Serial 1/0/0   
[AR1-Serial1/0/0]ppp authentication-mode pap     
# 只有认证端会选择认证的模式￼  
[AR2]interface Serial 1/0/0   
[AR2-Serial1/0/0]ppp pap local-user test password cipher Huawei@123 ￼
```

![Exported image](Exported%20image%2020251206143831-6.png)  
![Exported image](Exported%20image%2020251206143834-7.png)

```
￼CHAP模式：  
[AR1]aaa  
[AR1-aaa]local-user test password cipher Huawei@123   
[AR1-aaa]local-user test service-type ppp  
[AR1]int Serial 1/0/0   
[AR1-Serial1/0/0]ppp authentication-mode chap     
# 只有认证端会选择认证的模式￼  
[AR2]interface Serial 1/0/0  
[AR2-Serial1/0/0]ppp chap user test  
[AR2-Serial1/0/0]ppp chap password cipher Huawei@123
```
 ![Exported image](Exported%20image%2020251206143940-8.png)   
```
2、PPP的认证：  
1.PAP认证：密码认证协议  
  被认证端发起认证（发送request报文，携带 用户名+密码）  
  认证端收到request报文后，对携带的用户名+密码进行检查 和 自身存储的用户名+密码对比是否相同  
   1.如果相同，则回复ACK报文，表示认证通过  
    2.如果不同，则回复rejected报文，表示认证失败  
  *明文的用户名+密码传递，不安全
```
 
```
2.CHAP认证  
  认证端 发送 challenge 报文（携带 报文ID 、挑战随机数 、 可选的用户名）  
第一种情况： 认证端发送的挑战报文 不携带用户名：  
  被认证端 收到 挑战报文后 进行参数计算：  
    将自身接口用户名对应的密码 + 报文ID +  挑战随机数 通过 MD5计算 得到 HASH值1  
    通过respond报文（携带 HASH值1、报文ID、接口用户名）回复认证端  
  认证端收到respond报文后，进行参数计算：  
    找出 报文内接口用户名 对应的密码   
    将密码 + 报文ID + 挑战随机数 通过MD5计算 得到HASH值2  
    将HASH值1 和 HASH值2 进行对比：  
     1.如果值相等，则回复success报文 ，表示认证通过  
     2.如果值不等，则回复failure报文，表示认证失败￼  
第二种情况： 认证端发送的挑战报文 携带用户名：  
  被认证端 收到 挑战报文后 进行参数计算：  
     将报文内携带用户名对应的密码 + 报文ID +  挑战随机数 通过 MD5计算 得到 HASH值1  
     通过respond报文（携带 HASH值1、报文ID、接口用户名）回复认证端  
  认证端收到respond报文后，进行参数计算：  
     找出 报文内接口用户名 对应的密码   
     将密码 + 报文ID + 挑战随机数 通过MD5计算 得到HASH值2  
     将HASH值1 和 HASH值2 进行对比：  
     1.如果值相等，则回复success报文 ，表示认证通过  
     2.如果值不等，则回复failure报文，表示认证失败
```

```
动态NCP：￼
```

![Exported image](Exported%20image%2020251206143942-9.png)  

```
R2发出request：￼
```

![Exported image](Exported%20image%2020251206143946-10.png)

```
AR1给出回复：￼
```

![Exported image](Exported%20image%2020251206143948-11.png)

```
AR1给AR2分配地址
```

![Exported image](Exported%20image%2020251206144051-12.png)

```
￼AR2获取地址：￼
```

![Exported image](Exported%20image%2020251206144052-13.png)