```
OSPF在拓扑规划存在问题：（虚链路的使用场景）  
1.没有骨干区域  
2.非骨干区域没有和骨干区域连接  
3.存在多个骨干区域
```
 
```
虚链路是一种打破OSPF防环规则的技术，  
所以在网络规划的初期要避免使用虚链路技术  
一般使用在网络的过渡阶段，可以使网络可以正常通信，在网络恢复正常后，删除虚链路
```
   

```
如图1：不存在Area0  
不存在Area0的OSPF拓扑，不会通信，因为缺失了ABR
```

![Exported image](Exported%20image%2020251206152410-0.png)  

```
如图2：Area2没有与Area0直接相连  
1.正常的情况下，R1不能访问到R3与R4相连的网络  
2.如果想要他们直接能够通信，需要在R2，R3直接建立虚链路：  
[AR2]ospf  
[AR2-ospf-1]area 1   
[AR2-ospf-1-area-0.0.0.1]vlink-peer 10.3.3.3   
 #AR3同理
```

![Exported image](Exported%20image%2020251206152411-1.png)  

```
如图3：存在多个Area0（骨干区域备份）  
1.这个情况与图2相似，在R2与R3直接配置虚链路，也能是R1访问R4  
（如果R1访问R3，由于R3的将自己的三类扩散给R2，R2是ABR不会接收来自非骨干的三类，防环了，导致R1没R3的路由）
```

![Exported image](Exported%20image%2020251206152413-2.png)  

```
虚拟链路的使用场景：  
1.骨干区域备份  
2.访问路径次优  
3.访问环路  
\<AR6\>dis ospf vlink   查看虚链路邻居的建立
```
 
```
如图4：如果R4与R5之间的链路断开，那么R4还能访问R5吗？  
1.答案是不能：由于R1，R2都成为了ABR，所以说来自Area1的3类LSA在R2不会计算路由条目，所以说R2就没有R4的路由条目，故不能访问。  
***再次验证，ABR接收非骨干区域的3类LSA，不会计算路由条目
```

![Exported image](Exported%20image%2020251206152418-3.png)   
```
骨干区域备份：  
如图5：在R1和R2之间建立虚链路，当R4-R5之间断开后，相互之间仍然能够访问
```

![Exported image](Exported%20image%2020251206152420-4.png)   
```
访问路径次优：
```

![Exported image](Exported%20image%2020251206152422-5.png)  

```
如图6：R2-R3相连在Area1，R1存在loopback0，1.1.1.1  
1.在缺省情况下：R4访问R1的路径是：R4-R3-R1  
2.如果R3到R1的出接口cost=100，  
[AR3]interface  g0/0/1  
[AR3-GigabitEthernet0/0/1]ospf cost 100  
那么访问路径是：R4-R3-R1  
原因：  
1.即使在R4上开1.1.1.1/32的路由开销是：3
```

![Exported image](Exported%20image%2020251206152423-6.png)

```
2.但是到打R3过后，之间就走G0/0/1出口到达R1
```

![Exported image](Exported%20image%2020251206152426-7.png)

```
为什么呢？  
1.OSPF的路由计算是分布式的，即当数据包到达R3后，由R3自由计算。  
2.当R3将Area1的1类LSA转化为3类LSA在Area0泛洪，R2收到Area0的3类LSA会转发给R3，但R3是ABR，接收非骨干区域的3类LSA，不会计算路由条目，所以路由表中不存在走R2去R1的路由条目。  
总结：在我们上帝视角来看，R4-R3-R1是次优的路径，最优的应该市R4-R3-R2-R1，如果想让R4走最优的路径，就可以在R2-R3之间创建虚链路。
```
 
```
[AR2]ospf  
[AR2-ospf-1]area 1   
[AR2-ospf-1-area-0.0.0.1]vlink-peer 10.3.3.3 
```

```
如图：在AR8和AR9之间创建虚链路，
```

![Exported image](Exported%20image%2020251206152428-8.png)

```
注意：  
1.创建虚链路非骨干区域的路由器，就是增加骨干区域的路由器节点  
2.配置虚链路使用的是，连接路由器对端的RID，而是不是IP地址  
[AR2]ospf  
[AR2-ospf-1]area 1   
[AR2-ospf-1-area-0.0.0.1]vlink-peer 10.3.3.3   
3.虚链路邻居之间发送的是单播（DIP怎么得到？）  
因为同一区域之间能够使用SPF进行计算，可以以本端为根，计算对端的ip作为DIP，以对端为根，可以计算本端的ip作为SIP
```

![Exported image](Exported%20image%2020251206152430-9.png)

```
4.创建虚链路的两个路由器必须在同一区域  
建立虚链路的区域必须是非骨干区域  
5.建立虚链路的路由器会变成ABR（特殊类型的ABR）具备真    
      ABR的所有功能，但是存在部分限制  
6.建立虚链路的路由器：会在组播的时候在Flag字段，将V，B字段置位
```

![Exported image](Exported%20image%2020251206152435-10.png)  

```
7.建立虚链路的设备会在Area0中通告自身的1类LSA，（携带的链路状态就是描述虚链路的）  
  Type      : Router  
  Ls id     : 10.9.9.9   
  Adv rtr   : 10.9.9.9    
  Ls age    : 536   
  Len       : 36   
  Options   :  ABR  E    
  seq#      : 80000002   
  chksum    : 0xc9ab  
  Link count: 1  
   * Link ID: 10.8.8.8 （描述虚链路的邻居）    
     Data   : 10.1.89.9（去虚链路邻居走哪一条路）  
     Link Type: Virtual        
     Metric : 1  
         Area: 0.0.0.1  
 Link State Database 
```

```
在图中，如果AR10存在环回口，10.10.10.10，那么会在AR7的LSDB中存在几条10.10.10.10的1类LSA信息呢？   
（情景在线：  
1.AR10的环回口的1类LSA会通过AR9（作为假ABR）将1类LSA转换为3类LSA发给AR8（通过area 1）  
2.AR10的环回口的1类LSA会通过AR9（作为真ABR）将1类LSA转换为3类LSA发给AR8（通过vlink）)
```

![Exported image](Exported%20image%2020251206152437-11.png)

```
答案是：1条  
1.因为AR10将自己 的1类LSA信息泛洪给AR9，AR9是ABR，接收来自非骨干区域的1类LSA会转换为3类LSA，通过虚链路泛洪给Area0。  
2.AR9也会将来自AR10 的1类LSA信息转换为3类LSA信息通过G0/0/0泛洪到Area1，直到AR8，AR8也是ABR，接收来自非骨干区域的3类LSA信息,但是不计算路由。所以所在AR7的LSDB中只有一条10.10.10.10
```

![Exported image](Exported%20image%2020251206152438-12.png)   
```
8.建立虚链路的区域，称为虚链路穿越的区域（虚链路的开销就是，穿越区域的开销叠加）  
如图：R1到R4的环回接口就是：1+1+1=3￼虚链路的开销值为1+1=2  
***开销指的是流量出方向的接口cost
```

![Exported image](Exported%20image%2020251206152440-13.png)  

```
9.虚链路建立的ABR可以将连接的非骨干区域路由信息转换为3类LSA通过虚链路在骨干区域泛洪
```

![Exported image](Exported%20image%2020251206152442-14.png)  

```
虚链路的防环规则：  
1.要求建立虚链路的ABR，不能将骨干区域的1类、2类、3类转换3类LSA泛洪到 虚链路穿越的区域  
2.要求建立虚链路的ABR，将骨干区域的1类、2类、3类LSA泛洪到其他非骨干区域时，必须要在虚链路穿越的区域学习对应的3类LSA  
如图：就是当Area 0的1，2类LSA信息 以及与其他相连区域的3类LSA信息，通过Vlink进行传输时，必须要学习到Area1的3类LSA信息进行同步，因为，如果没有学习Area1的3类LSA信息，那么当数据包回来的时候，到达R3，就会被丢弃，原因是R3并不知道，去往Area0的路径
```

```
在Area 0 区域，与非骨干区域建立虚链路的路由器，会将V比特置位。
```

![Exported image](Exported%20image%2020251206152444-15.png)  

![Exported image](Exported%20image%2020251206152446-16.png)

```
当AR1和AR9都配置了环回接口，并配置地址；由于Vlink的存在，Area 0 和  Area2 都会相互学习到对方的LSA信息，并存在路由：  
[AR9]dis ip routing 1.1.1.1
```

![Exported image](Exported%20image%2020251206152450-17.png)

```
同理：AR1-AR9
```

![Exported image](Exported%20image%2020251206152452-18.png)  

```
但是问题是ping不通：
```

![Exported image](Exported%20image%2020251206152454-19.png)

```
1.问题排查：  
抓包查看问题：
```

![Exported image](Exported%20image%2020251206152455-20.png)  
![Exported image](Exported%20image%2020251206152457-21.png)

```
这就表明有可能出现了环路问题：
```
 
```
2.查看路由路径：  
AR1到9.9.9.9的下一跳是AR6
```

![Exported image](Exported%20image%2020251206152459-22.png)

```
AR6的下一跳是：AR2
```

![Exported image](Exported%20image%2020251206152500-23.png)  

```
AR2的下一跳居然是：AR1
```

![Exported image](Exported%20image%2020251206152505-24.png)

```
问题就处在这里，那么是什么原因导致的呢？
```

![Exported image](Exported%20image%2020251206152507-25.png)

```
原因：  
1.在AR3将Area 2 的1，2类LSA转换为3类LSA后，会向与AR3建立虚链路的AR6的Area0和AR3所在的Area1内泛洪。  
2.AR6接收到来自AR3的3类LSA后，在Area0中泛洪，让AR1接收到，然后AR1在转发给AR2。AR2再向Area1中泛洪。  
3.AR2，从Area1中接收到来自AR3的3类LSA信息后，不会向Area0中泛洪，因为AR2是ARB（***防环规则）  
4.综上，AR2去往AR9的路径就只有向AR1转发，AR1-AR6，AR6-AR2，AR2-AR1，导致环路。
```
 
![Exported image](Exported%20image%2020251206152509-26.png)