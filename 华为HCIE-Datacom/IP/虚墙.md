# 虚墙

**防火墙虚拟系统是指将一台物理防火墙设备从逻辑上划分为多个虚拟系统（虚拟墙）**
**虚拟墙的特点：**
- 管理独立  
- 资源分配  
- 流量隔离  
- 配置独立
- 
**物理防火墙和虚拟防火墙的关系：**
1.物理防火墙：
- 根墙使用根系统  
- 根墙具备管理虚墙的能力  
2.虚拟防火墙：虚墙使用虚拟系统

**==根墙和虚墙之间是一种广播型网络的链接  
根墙管理员可以创建虚拟系统管理员  
根墙管理员可以为虚拟系统分配资源  
跟系统可以实现虚拟系统之间的相互访问==**


资源分配：  
1.定额分配的资源  
   1.管理员不能配置的  
   2.系统产生后自动携带的资源（安全区域）  
2.手工配置的资源  
   1.接口、VLAN、IP地址等  
   2.保证值：可以使用某项资源的最小值  
   3.最大值：可以使用某项资源的最大值  
3.共享抢占的资源  
   1.时间段、带宽、表项资源等  
   2.一部分用户使用的多，一部分用户使用的少￼￼  
[FW1]vsys enable   
[FW1]vsys name A 1 创建虚拟系统，也会同时创建一个VPN实例￼**只是再根墙下创建虚拟系统，并没有过进入虚拟系统！  
[FW1-vsys-A]assign interface GigabitEthernet 1/0/0   
[FW1]vsys name B 5   
[FW1-vsys-B]assign interface GigabitEthernet 1/0/1
```
 
```
***虚拟系统必须存在一个虚拟系统ID  
***设备会根据虚拟系统ID值生成一个virtual-if 接口  
***根墙默认存在一个virtual-if 0接口
```
 
```
virtual-if接口之间提供了广播型的网络链接  
执行资源划分的接口，实际上就是绑定了对应虚拟系统的VPN实例  
[FW1]switch vsys A    虚拟系统之间相互切换￼￼  
虚拟系统的相互访问：  
**虚拟系统之间的流量默认是隔离的  
1.虚拟系统通过根系统实现相互访问￼（下面实现的是A-B的单向访问：如果需要双向访问需要添加安全策略）￼模拟器存在问题，不能很好展示如何通过根墙范围虚墙B的  
虚墙A：  
[FW1-A]interface GigabitEthernet 1/0/0   
[FW1-A-GigabitEthernet1/0/0]ip ad 192.168.1.254 24   
[FW1-A]firewall zone trust   
[FW1-A-zone-trust]add interface GigabitEthernet 1/0/0   
[FW1-A]interface Virtual-if 1   
[FW1-A-Virtual-if1]ip address 10.1.123.1 24   
[FW1-A]firewall zone untrust   
[FW1-A-zone-untrust]add interface Virtual-if 1   
[FW1-A]ip route-static 0.0.0.0 0 public ￼安全策略：  
[FW1-A]security-policy  
[FW1-A-policy-security]rule name 1_2  
[FW1-A-policy-security-rule-1_2]source-zone trust  
[FW1-A-policy-security-rule-1_2]destination-zone untrust  
[FW1-A-policy-security-rule-1_2]action permit   
根墙：  
[FW1]interface Virtual-if 0   
[FW1-Virtual-if0]ip address 10.1.123.2 24   
[FW1]firewall zone trust   
[FW1-zone-trust]add interface Virtual-if 0￼￼#防火墙存在BUG，不需要下面的路由也能互相访问（但是实测是需要下面两条路由）  
[FW1]ip route-static 192.168.1.0 24 vpn-instance A  
[FW1]ip route-static 192.168.2.0 24 vpn-instance B  
根墙因为只通过virtualif0接口链接虚墙，所以不需要写安全策略
```
 
```
虚墙B：  
[FW1-B]interface GigabitEthernet 1/0/1   
[FW1-B-GigabitEthernet1/0/0]ip ad 192.168.2.254 24   
[FW1-B]firewall zone trust   
[FW1-B-zone-trust]add interface GigabitEthernet 1/0/1   
[FW1-B]interface Virtual-if 5   
[FW1-B-Virtual-if1]ip address 10.1.123.3 24   
[FW1-B]firewall zone untrust   
[FW1-B-zone-untrust]add interface Virtual-if 1   
[FW1-B]ip route-static 0.0.0.0 0 public   
[FW1-B]security-policy  
[FW1-B-policy-security]rule name 1_2  
[FW1-B-policy-security-rule-1_2]source-zone untrust  
[FW1-B-policy-security-rule-1_2]destination-zone trust  
[FW1-B-policy-security-rule-1_2]action permit
```
 
```
2.虚拟系统不经过根系统实现相互访问  
主要是虚墙之间路由相互指为对方的VPN实例￼***通过这样才能真正意义上的实现不经过根墙直接访问虚墙B  
[FW1]ip route-static vpn-instance A 192.168.2.0 24 vpn-instance B   
[FW1]ip route-static vpn-instance B 192.168.1.0 24 vpn-instance A￼
```

![Exported image](Exported%20image%2020251206164928-0.png)

![Exported image](Exported%20image%2020251206164929-1.png)
 
```
其实这不太正确：￼似乎这里是有转发直接，触发了重定向机制￼
```

![Exported image](Exported%20image%2020251206164934-2.png)  
![Exported image](Exported%20image%2020251206164936-3.png)