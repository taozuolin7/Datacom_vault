# 第一步：承载网将CQ-OA-VPN替换为CSC-VPN
```
AR侧：
1）新建CSC的VPN，撤销省内CQ_OA的VPN，
用于发布loopback地址
配置：
ip vpn-instance ChinaMobile_CQ_CSC
  ipv4-family 
  route-distinguisher 24059:100
  apply-label peer-route #配置标签分配方式为每路由每标签
  routing-table limit 2000 80 #**routing-table limit**命令用来限制当前VPN实例相应地址族下所能容纳的路由数。
  # 2000:指定VPN实例相应地址族下可以支持的最大路由数。 # 80指定最大路由数的百分比。当加入VPN实例相应地址族的路由数到达（number×(alert-percent)）÷100时，系统开始产生告警信息。此时VPN实例相应地址族的路由表可以继续加入路由。但路由数到达number后，后来的VPN路由将被丢弃。
  vpn-target 24059:100 export-extcommunity 
  vpn-target 24059:100 import-extcommunity
  
  # 进入5.853子接口
interface Eth-Trunk5.835
 vlan-type dot1q 835 # 封装上vlan tag
 mpls
 ip binding vpn-instance ChinaMobile_CQ_CSC
 ip address 10.1.1.1 255.255.255.252
 statistic enable # 命令用来使能主接口的IPv4流量和IPv6流量统计功能
 
 
ipv4-family vpn-instance ChinaMobile_CQ_CSC
  network 10.1.1.0 255.255.255.252 
  maximum load-balancing 6 # 命令用来设置形成负载分担的等价路由的最大条数。缺省为不负载分担
  peer 10.1.1.2 as-number 65535
  peer 10.1.1.2 timer keepalive 10 hold 30 # 缺省情况下，存活时间为60秒，保持时间为180秒，会话保持时间为86400秒。 
  # BGP可以更快速的检测到链路的故障，从而实现链路切换，但是网络中的Keepalive消息会增多，会增加设备的负担，并且会占用一定的网络带宽。
  # **配置影响**
改变定时器的值会导致设备之间的BGP peer关系中断，这是因为对等体双方要重新协商实际的keepalive-time值和hold-time值。务必仔细确认是否必须改变定时器的值。

  peer 10.1.1.2 substitute-as # 命令用来在发布方向使能AS号替换功能，即用本地AS号替换AS_Path属性中指定对等体的AS号。
  # 这里应该是避免 as号的重复导致 as-path防环

PC侧：
1)利旧BGP邻居，端口下使能MPLS
interface gei-0/0/0/1.835
 mpls
```

# 第二步：AR与PC间进行BGP标签分发
```
AR侧:
写分标签策略并对所有传递给PC的路由分发BGP标签
route-policy mpls-label permit node 10
 apply mpls-label
 
bgp 24059
  ipv4-family vpn-instance ChinaMobile_OA_CSC
  peer 10.1.1.2 label-route-capability # 使能标签路由的转发能力
  peer 10.1.1.2 route-policy mpls-label export # 对 对端对等体使用路由策略，分配标签路由，默认的其他拒绝
  
  
PC侧:（Cisco 路由器）
写分标签策略并对所有传递给PC的路由分发BGP标签
route-map CSC # 路由策略（过滤、修改属性）的核心指令CSC
 set mpls-label # 为路由显式启用 MPLS 标签分发 
 
bgp 65535
 neighbor 10.1.1.1 send-label # Cisco 启用 **BGP Labeled Unicast（BGP LU）** 的核心命令（即通过 BGP 分发 MPLS 标签，而非传统的 LDP）同华为的：label-route-capability
 neighbor 10.1.1.1 route-map CSC out 对端对等体使用路由策略，分配标签路由，默认的其他拒绝
```

# 第三步：PC分发BGP标签给PA
```
PC侧:
写分标签策略并对所有传递给PA的路由分发BGP标签
bgp 65535
 neighbor 10.189.251.8 send-label
 neighbor 10.189.251.8 route-map CSC out
 
PA侧:
开启BGP标签能力，接收PC分配的标签
bgp 65535
 peer 10.189.251.7 label-route-capability
 peer 10.189.251.8 label-route-capability
```

# 第四步：创建一级RR
```
选取一对PC作为一级RR，反射重庆DCN全网所有业务路由

bgp 65535
 neighbor 1.1.1.1 remote-as 65535 
 neighbor 1.1.1.1 activate  # 在默认的IPv4单播地址族下激活该邻居，允许与该邻居收发IPv4单播路由（不激活则仅建立TCP会话，不交换路由）
 neighbor 1.1.1.1 default-originate # 向该邻居发布默认路由（0.0.0.0/0）：如果本地有默认路由则发布，若无则需加always参数强制发布；常用于让邻居以本端为默认网关

 neighbor 1.1.1.1 send-med # 允许向该邻居发送MED（Multi-Exit Discriminator）属性：MED是BGP路由属性，用于告知对端AS内不同出口的优先级（数值越小越优先）

 neighbor 1.1.1.1 update-source loopback1 # 指定BGP会话的源地址为本地loopback1接口的IP
 
address-family vpnv4 # 适配 IPv4 MPLS L3VPN
 neighbor 1.1.1.1 activate # 在VPNv4地址族下激活该邻居，允许与该邻居交换VPNv4路由

 neighbor 1.1.1.1 route-reflector-client # 配置邻居为反射客户端
address-family vpnv6 # 适配 IPv6 MPLS L3VPN
 neighbor 1.1.1.1 activate
 neighbor 1.1.1.1 route-reflector-client
```

# 第五步：PC与一级RR建立邻居
```
所有PC侧:
与一级RR建立邻居，PC此时可以接收全网所有VPN业务路由并反射所有PA
 bgp 65535
 neighbor 2.2.2.2 remote-as 65535
 neighbor 2.2.2.2 activate 
 neighbor 2.2.2.2 default-originate
 neighbor 2.2.2.2 send-med 
 neighbor 2.2.2.2 update-source loopback1
 
address-family vpnv4
 neighbor 2.2.2.2 activate
address-family vpnv6
 neighbor 2.2.2.2 activate

该配置完成后，由于从一级RR接收到的业务路由AS PATH较短（只有65535，而从承载网接收到路由还存在24059），PC会优选AS PATH较短的路由。因此，此时流量会全部切换到CSC子接口上。
```